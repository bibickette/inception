# üéØ Le but principal de ce script est :
# üëâ Cr√©er une base de donn√©es SQL et un utilisateur associ√©, automatiquement, au d√©marrage du container MariaDB.

# ‚úÖ Ce que le script fait concr√®tement :
# D√©marre MariaDB
# Cr√©e une base de donn√©es
# Cr√©e un utilisateur avec un mot de passe
# Donne √† cet utilisateur les droits sur la base
# Modifie le mot de passe du compte root
# Recharge les droits
# Red√©marre MariaDB proprement

# üß† Pourquoi on le fait ?
# Parce que MariaDB d√©marre vide par d√©faut : pas de base, pas d‚Äôutilisateur (sauf root)
# WordPress (ou tout autre app) a besoin d‚Äôune base + un utilisateur pour se connecter
# √áa rend ton container automatis√© et r√©utilisable sur n'importe quelle machine

# ‚úÖ R√©sum√© simple pour tes notes :
# # Script d'init MariaDB

# üéØ Objectif :
# - Cr√©er une base SQL automatiquement
# - Cr√©er un utilisateur avec mot de passe
# - Donner les droits √† cet utilisateur
# - √âviter de faire √ßa √† la main √† chaque fois

# üì¶ Important pour :
# - WordPress
# - phpMyAdmin
# - Toute app qui utilise une base

# üìÅ Le script est lanc√© au d√©marrage du container

#!/bin/bash
# La commande service permet de d√©marrer MySQL avec la commande associ√©e.
service mysql start;

# demande de cr√©er une table si elle n‚Äôexiste pas d√©j√†, du nom de la variable d‚Äôenvironnement SQL_DATABASE, indiqu√© dans mon fichier .env qui sera envoy√© par le docker-compose.yml.
mysql -e "CREATE DATABASE IF NOT EXISTS \`${SQL_DATABASE}\`;"

# cr√©e l‚Äôutilisateur SQL_USER s‚Äôil n‚Äôexiste pas, avec le mot de passe SQL_PASSWORD , toujours √† indiquer dans le .env
mysql -e "CREATE USER IF NOT EXISTS \`${SQL_USER}\`@'localhost' IDENTIFIED BY '${SQL_PASSWORD}';"

# donne les droits √† l‚Äôutilisateur SQL_USER avec le mot de passe SQL_PASSWORD pour la table SQL_DATABASE
mysql -e "GRANT ALL PRIVILEGES ON \`${SQL_DATABASE}\`.* TO \`${SQL_USER}\`@'%' IDENTIFIED BY '${SQL_PASSWORD}';"

# change les droits root par localhost, avec le mot de passe root SQL_ROOT_PASSWORD
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '${SQL_ROOT_PASSWORD}';"

# Plus qu‚Äô√† rafraichir tout cela pour que MySQL le prenne en compte.
mysql -e "FLUSH PRIVILEGES;"

# Il ne nous reste plus qu‚Äô√† red√©marrer MySQL pour que tout cela soit effectif !
# Arr√™te proprement MySQL
mysqladmin -u root -p$SQL_ROOT_PASSWORD shutdown

# Red√©marre MySQL proprement
exec mysqld_safe
